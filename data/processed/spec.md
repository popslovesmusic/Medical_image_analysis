# Module Specification

**Path:** data/processed
**Generated by:** Codex cleanup task
**Date:** 2025-10-31

---
Specification: Processed Data Layer

Module Path: data/processed/
Parent Specs:

data/spec.md (data layer overview)

trainer/spec.md (pipeline interface)

core/tensor/spec.md (serialization and numerical format rules)

I. Mission

The Processed Data Layer transforms immutable raw imaging data into model-ready, deterministic representations — such as normalized image tensors, segmentation masks, and serialized Chromatic/Spectral tensors.

This layer is the canonical bridge between real-world medical imagery and the mathematical abstractions used by the Cognitive Core.

Its design prioritizes:

✅ Traceability (manifest links back to source)

✅ Determinism (reproducible preprocessing)

✅ Integrity (byte-level parity and manifest validation)

II. Directory Layout
data/processed/
├─ tensors/            # Serialized ChromaticTensor (.cten) & SpectralTensor (.sten)
├─ slices/             # 2D or 3D anatomical image slices
├─ masks/              # ROI or segmentation masks (binary or multi-class)
├─ manifests/          # JSON linking processed → raw lineage
├─ logs/               # Validation reports
└─ reports/            # Summary statistics and audit outputs

III. Core Data Types
1. ChromaticTensor (.cten)

Stores RGB-normalized image tensors

Data type: f32, shape [H, W, 3]

Derived from standardized preprocessing pipeline

Encodes luminance, contrast, and color space normalization

Header format:

{
  "type": "ChromaticTensor",
  "version": "1.0",
  "origin_uid": "MRI_000134",
  "dimensions": [512, 512, 3],
  "seed": 42,
  "crc64": "b47af09de3c4a9a2"
}

2. SpectralTensor (.sten)

Stores frequency-domain representations

Data type: f32, length = number of bands

Deterministically derived via FFT and Gaussian accumulation

Header format:

{
  "type": "SpectralTensor",
  "bands": 256,
  "origin_uid": "CT_000312",
  "f_min": 110.0,
  "octaves": 7,
  "crc64": "1aeac4b32f91a311"
}

3. Mask Files (.msk / .png / .npy)

Binary (foreground/background) or multi-class (e.g. tissue type) masks

Fixed-size (same dimensions as tensor)

Compression: PNG (16-bit) or NPY (float32)

IV. Preprocessing Pipeline

The deterministic preprocessing sequence is defined by the trainer configuration file:
trainer/config/preprocess.toml

Pipeline Steps
Step	Operation	Parameters	Determinism Rule
1	DICOM → Array	Window/Level	Round to 4 decimals
2	Resampling	[512×512]	Fixed interpolation order
3	Normalization	Min–Max scaling	Clamp [0,1]
4	Color Encoding	HSL or RGB (linearized)	Gamma = 1.0
5	Chromatic Conversion	→ .cten	Fixed seed = 42
6	Spectral Transform	FFT + Gaussian	Power-preserving kernel
7	Manifest Logging	JSON	Includes all seeds and CRCs
V. Manifests and Provenance

Each processed file must have an entry in a manifest (processed/manifests/manifest_<date>.json) referencing:

Source UID (raw/metadata/*.json)

Transformation hash

Timestamps

Checksums (CRC-64)

Parameters (windowing, normalization, kernel sizes, etc.)

Example:

{
  "uid": "MRI_000134",
  "source": "raw/DICOM/MRI_000134.dcm",
  "processed_files": [
    "processed/tensors/MRI_000134.cten",
    "processed/slices/MRI_000134_slice_05.png"
  ],
  "checksum_crc64": "b47af09de3c4a9a2",
  "seed": 42,
  "parameters": {
    "resample": "bilinear",
    "normalize": true,
    "gamma": 1.0
  }
}

VI. Determinism Constraints

To ensure byte-for-byte reproducibility:

Seed Control: every transformation uses the manifest-defined seed.

Fixed Order: file iteration is lexicographic (sorted(os.listdir(...))).

Precision: always round intermediate floats to 1e⁻⁶ precision.

Hash Stability: all CRC-64 hashes computed over identical byte streams.

No Stochastic Augmentations: rotations, flips, or jitters are disabled at this stage.

VII. Validation Metrics
Metric	Description	Threshold
Δmean_intensity	Mean drift between raw and processed image	≤ 1%
chromatic_coherence	Internal RGB/HSL consistency	≥ 0.95
fft_energy_balance_db	Power drift between spatial/spectral	≤ 0.5 dB
manifest_valid	JSON schema integrity	100% valid
crc_stable	Recomputed CRC identical	True

All validations are automatically executed by
core/src/diagnostics/metrics.rs and logged to processed/logs/validation_<timestamp>.json.

VIII. Error Handling and Recovery

Incomplete Manifest: skip ingestion and mark file "status": "orphaned".

Hash Mismatch: quarantine file in /data/processed/reports/quarantine/.

Processing Failure: capture stderr to /data/processed/logs/errors_<timestamp>.txt.

Automatic Rebuild: flagged tensors are regenerated during next preprocessing run.

IX. Integration with Trainer and Core
Consumer	Reads	Writes	Description
trainer	processed/tensors	processed/manifests	Loads for batch training
core/tensor	processed/tensors	processed/tensors	Performs Chromatic↔Spectral round-trips
core/diagnostics	processed/manifests	processed/logs	Runs validation metrics
meta/chronicle	processed/logs	experiments/results	Archives validation outcomes
X. Retention and Storage Policy
Category	Retention	Notes
Tensors	2 years	Regenerated on model version change
Slices	6 months	Derived from raw images
Masks	Permanent	Used for supervised datasets
Manifests	Permanent	Immutable provenance records
Logs	6 months	Rotated nightly
XI. Compliance
Field	Specification
Spec Version	1.0
Determinism Level	Bit-Exact
Seed Policy	Global deterministic (42)
Hash Algorithm	CRC-64/ISO
FFT Kernel	Gaussian (σ fixed per dataset)
Maintainer	Data Integrity Agent (Codex)
Revision	{{auto-date}}
Audit Passed	✅ Core–Trainer synchronization verified